version: '3.8'

services:
  live-trading:
    build:
      context: .
      dockerfile: Dockerfile.live-trading
    image: graphwiz-live-trading:latest
    container_name: graphwiz-live-trading
    restart: unless-stopped

    environment:
      - TRADING_MODE=live
      - KRAKEN_API_KEY=${KRAKEN_API_KEY}
      - KRAKEN_API_SECRET=${KRAKEN_API_SECRET}
      - NEO4J_URI=${NEO4J_URI:-bolt://host.docker.internal:7687}
      - NEO4J_USERNAME=${NEO4J_USERNAME:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - PYTHONUNBUFFERED=1
      - MAX_POSITION_EUR=${MAX_POSITION_EUR:-250}
      - MAX_DAILY_TRADES=${MAX_DAILY_TRADES:-25}
      - MAX_DAILY_LOSS_EUR=${MAX_DAILY_LOSS_EUR:-75}
      - UPDATE_INTERVAL_SECONDS=${UPDATE_INTERVAL_SECONDS:-30}
      - GOEMOTIONS_MIN_DATA_POINTS=${GOEMOTIONS_MIN_DATA_POINTS:-3}
      - GOEMOTIONS_MAX_POSITION_PCT=${GOEMOTIONS_MAX_POSITION_PCT:-0.25}
      - AUTO_CONFIRM=yes

    volumes:
      - ./logs/live_trading:/app/logs/live_trading
      - ./config:/app/config:ro
      - ./data:/app/data

    ports:
      - "8082:8080"  # Health check endpoint
      - "9090:9090"  # Metrics endpoint

    networks:
      - trading-network

    healthcheck:
      test: ["CMD", "pgrep", "-f", "scripts/live_trade.py"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

networks:
  trading-network:
    driver: bridge
